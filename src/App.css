import React, { useState, useEffect, useRef } from 'react';
import './App.css';

const DEX_DATA = [
  { id: '1inch', name: '1inch', color: '#2f8af5' },
  { id: 'uniswap', name: 'Uniswap v3', color: '#ff007a' },
  { id: 'sushiswap', name: 'SushiSwap', color: '#fa52a0' },
  { id: 'pancakeswap', name: 'PancakeSwap', color: '#d1884f' }
];

const COINS = ['TON', 'ETH', 'SOL', 'BNB', 'ARB', 'BTC'];

function App() {
  const [balance, setBalance] = useState(() => parseFloat(localStorage.getItem('k_bal')) || 100);
  const [tab, setTab] = useState('mining'); // mining, kross, settings
  const [activeDex, setActiveDex] = useState(null); // null = —Å–ø–∏—Å–æ–∫ –±–∏—Ä–∂, –∏–ª–∏ id –±–∏—Ä–∂–∏
  const [signal, setSignal] = useState(null);
  const [clicks, setClicks] = useState([]);
  const [inventory, setInventory] = useState({}); // –ö—É–ø–ª–µ–Ω–Ω—ã–µ –º–æ–Ω–µ—Ç—ã

  const audio = useRef(new Audio('https://www.soundjay.com/buttons/sounds/button-37a.mp3'));

  useEffect(() => {
    localStorage.setItem('k_bal', balance);
  }, [balance]);

  // –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å–∏–≥–Ω–∞–ª–æ–≤ (–ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç-–ø–æ–¥—Å–∫–∞–∑–∫–∞)
  useEffect(() => {
    const gen = () => {
      const b = DEX_DATA[Math.floor(Math.random() * 4)];
      let s = DEX_DATA[Math.floor(Math.random() * 4)];
      while(b.id === s.id) s = DEX_DATA[Math.floor(Math.random() * 4)];
      setSignal({
        coin: COINS[Math.floor(Math.random() * COINS.length)],
        buyAt: b.id,
        sellAt: s.id,
        profit: (Math.random() * 2 + 1).toFixed(2),
        time: 30
      });
    };
    gen();
    const int = setInterval(gen, 30000);
    return () => clearInterval(int);
  }, []);

  const handleTap = (e) => {
    setBalance(b => b + 0.01);
    const id = Date.now();
    setClicks([...clicks, {id, x: e.clientX, y: e.clientY}]);
    setTimeout(() => setClicks(c => c.filter(i => i.id !== id)), 800);
  };

  // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫—É–ø–∫–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –±–∏—Ä–∂–µ
  const buyCoin = (coin) => {
    if (balance >= 50) {
      setBalance(prev => prev - 50);
      setInventory(prev => ({ ...prev, [coin]: (prev[coin] || 0) + 1 }));
      alert(`–í—ã –∫—É–ø–∏–ª–∏ ${coin} –Ω–∞ –±–∏—Ä–∂–µ ${activeDex}`);
    } else {
      alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ (–Ω—É–∂–Ω–æ $50)");
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–¥–∞–∂–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –±–∏—Ä–∂–µ
  const sellCoin = (coin) => {
    if (inventory[coin] > 0) {
      let finalPrice = 50;
      // –ï—Å–ª–∏ –ø—Ä–æ–¥–∞–µ–º —Ç–∞–º, –≥–¥–µ —Å–∫–∞–∑–∞–ª —Å–∏–≥–Ω–∞–ª ‚Äî –¥–∞–µ–º –ø—Ä–æ—Ñ–∏—Ç
      if (signal && activeDex === signal.sellAt && coin === signal.coin) {
        finalPrice = 50 * (1 + parseFloat(signal.profit) / 100);
        alert(`–£—Å–ø–µ—à–Ω—ã–π –∞—Ä–±–∏—Ç—Ä–∞–∂! –ü—Ä–∏–±—ã–ª—å: +${signal.profit}%`);
      } else {
        finalPrice = 50 * 0.95; // –ü—Ä–æ–¥–∞–∂–∞ –≤ –º–∏–Ω—É—Å (–∫–æ–º–∏—Å—Å–∏—è), –µ—Å–ª–∏ –Ω–µ –ø–æ —Å–∏–≥–Ω–∞–ª—É
        alert("–ü—Ä–æ–¥–∞–∂–∞ –±–µ–∑ —Å–∏–≥–Ω–∞–ª–∞ –∏–ª–∏ –Ω–µ –Ω–∞ —Ç–æ–π –±–∏—Ä–∂–µ (–∫–æ–º–∏—Å—Å–∏—è -5%)");
      }
      setBalance(prev => prev + finalPrice);
      setInventory(prev => ({ ...prev, [coin]: prev[coin] - 1 }));
    }
  };

  return (
    <div className="app">
      <header className="header">
        <div className="logo">Kross-DEX</div>
        <div className="bal"><span>Balance:</span> <b>${balance.toFixed(2)}</b></div>
      </header>

      <main className="content">
        {tab === 'mining' && (
          <div className="mining">
            <div className="coin-btn" onClick={handleTap}>
              $ {clicks.map(c => <span key={c.id} className="f-text" style={{left: c.x, top: c.y}}>+$0.01</span>)}
            </div>
            <p>Tap to earn commission!</p>
          </div>
        )}

        {tab === 'kross' && (
          <div className="kross-container">
            {/* –ü–∞–Ω–µ–ª—å —Å–∏–≥–Ω–∞–ª–∞ (–≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω–∞ —Å–≤–µ—Ä—Ö—É –≤ —ç—Ç–æ–π –≤–∫–ª–∞–¥–∫–µ) */}
            {signal && (
              <div className="signal-bar">
                <div className="signal-hint">
                  üí° SIGNAL: Buy <b>{signal.coin}</b> on <span className="blue">{signal.buyAt}</span> ‚ûî Sell on <span className="orange">{signal.sellAt}</span> (+{signal.profit}%)
                </div>
              </div>
            )}

            {!activeDex ? (
              <div className="dex-list">
                <h3>Select Exchange:</h3>
                {DEX_DATA.map(dex => (
                  <div key={dex.id} className="dex-item" style={{borderColor: dex.color}} onClick={() => setActiveDex(dex.id)}>
                    <div className="dex-dot" style={{backgroundColor: dex.color}}></div>
                    {dex.name} <span>‚ûî</span>
                  </div>
                ))}
              </div>
            ) : (
              <div className="dex-terminal">
                <button className="back-btn" onClick={() => setActiveDex(null)}>‚Üê Back to Markets</button>
                <h2 style={{color: DEX_DATA.find(d => d.id === activeDex).color}}>{activeDex.toUpperCase()} TERMINAL</h2>
                
                <div className="coin-market">
                  {COINS.map(c => (
                    <div key={c} className="coin-row">
                      <span>{c}/USDT</span>
                      <div className="actions">
                        <button className="buy" onClick={() => buyCoin(c)}>BUY</button>
                        <button className="sell" onClick={() => sellCoin(c)} disabled={!inventory[c]}>SELL ({inventory[c] || 0})</button>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}
      </main>

      <nav className="nav">
        <button className={tab==='mining'?'active':''} onClick={()=>{setTab('mining'); setActiveDex(null)}}>Mining</button>
        <button className={tab==='kross'?'active':''} onClick={()=>setTab('kross')}>Kross-DEX</button>
        <button className={tab==='settings'?'active':''} onClick={()=>setTab('settings')}>Settings</button>
      </nav>
    </div>
  );
}

export default App;
}

import React, { useState, useEffect } from 'react';
import './App.css';

const tg = window.Telegram?.WebApp;

function App() {
  // –°–æ—Å—Ç–æ—è–Ω–∏—è
  const [balance, setBalance] = useState(() => Number(localStorage.getItem('hBal')) || 0);
  const [energy, setEnergy] = useState(() => Number(localStorage.getItem('hEn')) || 1000);
  const [tab, setTab] = useState('home'); // –í–∫–ª–∞–¥–∫–∏: home –∏–ª–∏ shop

  // –£–ª—É—á—à–µ–Ω–∏—è (Upgrades)
  const [multiTap, setMultiTap] = useState(() => Number(localStorage.getItem('hMulti')) || 1);
  const [energyRegen, setEnergyRegen] = useState(() => Number(localStorage.getItem('hRegen')) || 1);

  const [clicks, setClicks] = useState([]);

  // –°—Ç–æ–∏–º–æ—Å—Ç—å —É–ª—É—á—à–µ–Ω–∏–π
  const multiTapCost = multiTap * 1000;
  const energyRegenCost = energyRegen * 1500;

  // –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è —ç–Ω–µ—Ä–≥–∏–∏ (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Ä–æ–≤–Ω—è –ø—Ä–æ–∫–∞—á–∫–∏)
  useEffect(() => {
    const timer = setInterval(() => {
      setEnergy(prev => (prev < 1000 ? prev + energyRegen : 1000));
    }, 1500);
    return () => clearInterval(timer);
  }, [energyRegen]);

  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
  useEffect(() => {
    localStorage.setItem('hBal', balance);
    localStorage.setItem('hEn', energy);
    localStorage.setItem('hMulti', multiTap);
    localStorage.setItem('hRegen', energyRegen);
  }, [balance, energy, multiTap, energyRegen]);

  const handleTap = (e) => {
    if (energy < multiTap) return;
    if (tg) tg.HapticFeedback.impactOccurred('medium');

    setBalance(b => b + multiTap);
    setEnergy(e => e - multiTap);

    const id = Date.now();
    const x = e.clientX || e.touches[0].clientX;
    const y = e.clientY || e.touches[0].clientY;
    setClicks(prev => [...prev, { id, x, y }]);
    setTimeout(() => setClicks(prev => prev.filter(c => c.id !== id)), 800);
  };

  // –§—É–Ω–∫—Ü–∏–∏ –ø–æ–∫—É–ø–∫–∏
  const buyMultiTap = () => {
    if (balance >= multiTapCost) {
      setBalance(b => b - multiTapCost);
      setMultiTap(m => m + 1);
    }
  };

  const buyEnergyRegen = () => {
    if (balance >= energyRegenCost) {
      setBalance(b => b - energyRegenCost);
      setEnergyRegen(r => r + 1);
    }
  };

  return (
    <div className="app-container">
      <div className="balance-header">
        <img src="https://cryptologos.cc/logos/tether-usdt-logo.png" width="25" alt="coin" />
        <h1>{Math.floor(balance).toLocaleString()}</h1>
      </div>

      <main className="main-content">
        {tab === 'home' ? (
          <div className="home-view">
            <div className="clicker-area" onClick={handleTap}>
              <div className="hamster-circle">üêπ</div>
              {clicks.map(c => (
                <div key={c.id} className="tap-text" style={{ left: c.x, top: c.y }}>
                  +{multiTap}
                </div>
              ))}
            </div>
            
            <div className="energy-bar-container">
              <div className="energy-info">‚ö° {energy} / 1000</div>
              <div className="energy-bg"><div className="energy-fill" style={{ width: `${(energy / 10) || 0}%` }}></div></div>
            </div>
          </div>
        ) : (
          <div className="shop-view">
            <h2>–ú–∞–≥–∞–∑–∏–Ω —É–ª—É—á—à–µ–Ω–∏–π</h2>
            
            <div className="shop-item" onClick={buyMultiTap}>
              <div className="item-info">
                <h3>–ú—É–ª—å—Ç–∏-—Ç–∞–ø (Lvl {multiTap})</h3>
                <p>–î–∞–µ—Ç +1 –∫ –∫–∞–∂–¥–æ–º—É –∫–ª–∏–∫—É</p>
                <span className="price">üí∞ {multiTapCost}</span>
              </div>
              <button disabled={balance < multiTapCost}>–ö—É–ø–∏—Ç—å</button>
            </div>

            <div className="shop-item" onClick={buyEnergyRegen}>
              <div className="item-info">
                <h3>–†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è (Lvl {energyRegen})</h3>
                <p>–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏—é –±—ã—Å—Ç—Ä–µ–µ</p>
                <span className="price">üí∞ {energyRegenCost}</span>
              </div>
              <button disabled={balance < energyRegenCost}>–ö—É–ø–∏—Ç—å</button>
            </div>
          </div>
        )}
      </main>

      <nav className="bottom-menu">
        <button onClick={() => setTab('home')} className={tab === 'home' ? 'active' : ''}>üêπ –ò–≥—Ä–∞</button>
        <button onClick={() => setTab('shop')} className={tab === 'shop' ? 'active' : ''}>üõí –ú–∞–≥–∞–∑–∏–Ω</button>
      </nav>
    </div>
  );
}

export default App;
/* –ú–∞–≥–∞–∑–∏–Ω */
.shop-view { width: 100%; padding: 20px; box-sizing: border-box; }
.shop-item {
  background: #1c1c1e;
  border-radius: 15px;
  padding: 15px;
  margin-bottom: 15px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border: 1px solid #333;
}
.item-info h3 { margin: 0; font-size: 16px; color: #fff; }
.item-info p { margin: 5px 0; font-size: 12px; color: #888; }
.price { color: #f1c40f; font-weight: bold; }

.shop-item button {
  background: #f1c40f;
  color: #000;
  border: none;
  padding: 10px 15px;
  border-radius: 10px;
  font-weight: bold;
}
.shop-item button:disabled { background: #555; color: #888; }

/* –ù–∏–∂–Ω–µ–µ –º–µ–Ω—é */
.bottom-menu {
  position: fixed;
  bottom: 0;
  width: 100%;
  height: 70px;
  background: #111;
  display: flex;
  justify-content: space-around;
  align-items: center;
  border-top: 1px solid #333;
}
.bottom-menu button {
  background: none;
  border: none;
  color: #888;
  font-size: 16px;
  font-weight: bold;
}
.bottom-menu button.active { color: #f1c40f; }

.tap-text {
  position: fixed;
  color: #f1c40f;
  font-size: 32px;
  font-weight: 900;
  pointer-events: none;
  animation: floatUp 0.8s forwards;
}
.shop-item button:disabled {
  background: #2ecc71; /* –ó–µ–ª–µ–Ω—ã–π —Ü–≤–µ—Ç –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π */
  color: white;
  opacity: 1;
}
